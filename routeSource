<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hazard-Aware Routing Demo</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Leaflet.draw CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      max-width: 260px;
      font-size: 13px;
    }

    .control-panel h2 {
      margin: 0 0 4px;
      font-size: 16px;
    }

    .control-panel button {
      margin: 2px 0;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 13px;
    }

    .control-panel button.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    .info-line {
      margin-top: 4px;
    }

    .small {
      font-size: 11px;
      color: #555;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="control-panel">
  <h2>Safe Route Demo</h2>
  <p class="small">
    1) Click <b>Start</b> then click on the map.<br />
    2) Click <b>End</b> then click on the map.<br />
    3) Draw avoid zones with the draw tools (left side of map).<br />
    4) Click <b>Get Safe Route</b>.
  </p>

  <div>
    <button id="btn-start">Set Start</button>
    <button id="btn-end">Set End</button>
  </div>

  <div style="margin-top: 6px;">
    <button id="btn-route">Get Safe Route</button>
  </div>

  <div class="info-line small" id="info-start">Start: not set</div>
  <div class="info-line small" id="info-end">End: not set</div>
  <div class="info-line small" id="info-avoid">Avoid zones: 0</div>
  <div class="info-line small" id="info-hazards">Hazard polygons: 1 (demo)</div>
  <div class="info-line small" id="info-status">Status: idle</div>

  <p class="small" style="margin-top: 6px;">
    This demo uses OpenRouteService with OpenStreetMap data and a sample hazard polygon.
  </p>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet.draw JS -->
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
  // ====== CONFIG ======
  const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImFlY2U1Y2I5NGMwNTQ1YTBhNWU3MGJmZmQ4MmM1YjQ2IiwiaCI6Im11cm11cjY0In0="; // <-- Put your ORS key here
  const ORS_URL = "https://api.openrouteservice.org/v2/directions/driving-car/geojson";

  // ====== MAP SETUP ======
  const map = L.map("map").setView([41.65, -83.54], 11); // Center roughly around Toledo

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  // FeatureGroup for user-drawn avoid polygons
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Leaflet.draw control
  const drawControl = new L.Control.Draw({
    edit: {
      featureGroup: drawnItems
    },
    draw: {
      polygon: true,
      rectangle: true,
      polyline: false,
      circle: false,
      circlemarker: false,
      marker: false
    }
  });
  map.addControl(drawControl);

  // ====== STATE ======
  let clickMode = null; // "start" | "end" | null

  let startMarker = null;
  let endMarker = null;
  let startCoords = null; // [lat, lng]
  let endCoords = null;   // [lat, lng]

  let avoidFeatures = []; // GeoJSON features from drawnItems
  let routeLayer = null;  // GeoJSON layer for route

  // Demo hazard polygon (you can replace with real hazard data later)
  const hazardFeatures = [
    {
      type: "Feature",
      properties: { source: "demo", hazard: "wildfire", severity: "high" },
      geometry: {
        type: "Polygon",
        coordinates: [[
          [-83.60, 41.66],
          [-83.57, 41.66],
          [-83.57, 41.69],
          [-83.60, 41.69],
          [-83.60, 41.66]
        ]]
      }
    }
  ];

  const hazardsLayer = L.geoJSON(hazardFeatures, {
    style: { color: "red", weight: 2, dashArray: "4 2" }
  }).addTo(map);

  // ====== UI ELEMENTS ======
  const btnStart = document.getElementById("btn-start");
  const btnEnd = document.getElementById("btn-end");
  const btnRoute = document.getElementById("btn-route");

  const infoStart = document.getElementById("info-start");
  const infoEnd = document.getElementById("info-end");
  const infoAvoid = document.getElementById("info-avoid");
  const infoHazards = document.getElementById("info-hazards");
  const infoStatus = document.getElementById("info-status");

  infoHazards.textContent = "Hazard polygons: " + hazardFeatures.length;

  function setStatus(msg) {
    infoStatus.textContent = "Status: " + msg;
  }

  function updateInfoPanels() {
    infoStart.textContent = "Start: " + (startCoords ? startCoords[0].toFixed(4) + ", " + startCoords[1].toFixed(4) : "not set");
    infoEnd.textContent = "End: " + (endCoords ? endCoords[0].toFixed(4) + ", " + endCoords[1].toFixed(4) : "not set");
    infoAvoid.textContent = "Avoid zones: " + avoidFeatures.length;
  }

  function setClickMode(mode) {
    clickMode = mode;
    btnStart.classList.toggle("active", mode === "start");
    btnEnd.classList.toggle("active", mode === "end");
  }

  btnStart.addEventListener("click", () => setClickMode("start"));
  btnEnd.addEventListener("click", () => setClickMode("end"));

  // ====== MAP CLICK TO SET START/END ======
  map.on("click", (e) => {
    if (!clickMode) return;

    const latlng = e.latlng;

    if (clickMode === "start") {
      if (startMarker) map.removeLayer(startMarker);
      startMarker = L.marker(latlng).addTo(map).bindPopup("Start");
      startCoords = [latlng.lat, latlng.lng];
    } else if (clickMode === "end") {
      if (endMarker) map.removeLayer(endMarker);
      endMarker = L.marker(latlng).addTo(map).bindPopup("End");
      endCoords = [latlng.lat, latlng.lng];
    }

    updateInfoPanels();
  });

  // ====== HANDLE DRAW EVENTS (AVOID ZONES) ======
  function refreshAvoidFeatures() {
    const geojson = drawnItems.toGeoJSON();
    avoidFeatures = geojson.features || [];
    updateInfoPanels();
  }

  map.on(L.Draw.Event.CREATED, (e) => {
    drawnItems.addLayer(e.layer);
    refreshAvoidFeatures();
  });

  map.on(L.Draw.Event.EDITED, () => {
    refreshAvoidFeatures();
  });

  map.on(L.Draw.Event.DELETED, () => {
    refreshAvoidFeatures();
  });

  // ====== HELPER: BUILD MULTIPOLYGON FOR ORS ======
  function buildAvoidMultiPolygon(features) {
    const polys = [];

    features.forEach((f) => {
      if (!f || !f.geometry) return;

      if (f.geometry.type === "Polygon") {
        polys.push(f.geometry.coordinates);
      } else if (f.geometry.type === "MultiPolygon") {
        f.geometry.coordinates.forEach((poly) => polys.push(poly));
      }
      // ignore other geometry types (LineString, Point, etc.)
    });

    if (!polys.length) return null;

    return {
      type: "MultiPolygon",
      coordinates: polys
    };
  }

  // ====== ROUTING FUNCTION ======
  async function getSafeRoute() {
    if (!startCoords || !endCoords) {
      alert("Set both a start and an end point first.");
      return;
    }

    setStatus("Requesting route...");

    // ORS expects [lon, lat]
    const startLonLat = [startCoords[1], startCoords[0]];
    const endLonLat = [endCoords[1], endCoords[0]];

    // Combine user avoid polygons + hazard polygons
    const combinedAvoidFeatures = [
      ...avoidFeatures,
      ...hazardFeatures
    ];

    const body = {
      coordinates: [startLonLat, endLonLat],
      format: "geojson",
      instructions: false,
      options: {}
    };

    // Build MultiPolygon geometry for avoid_polygons
    const avoidGeom = buildAvoidMultiPolygon(combinedAvoidFeatures);
    if (avoidGeom) {
      body.options.avoid_polygons = avoidGeom;
    }

    try {
      const resp = await fetch(ORS_URL, {
        method: "POST",
        headers: {
          "Authorization": ORS_API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!resp.ok) {
        const text = await resp.text();
        console.error("ORS error:", text);
        alert("Routing failed: " + resp.status + " - " + text);
        setStatus("error");
        return;
      }

      const data = await resp.json();

      // Remove old route if exists
      if (routeLayer) {
        map.removeLayer(routeLayer);
      }

      routeLayer = L.geoJSON(data, {
        style: { color: "blue", weight: 4 }
      }).addTo(map);

      // Fit map to route bounds if available
      try {
        const bounds = routeLayer.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds, { padding: [30, 30] });
        }
      } catch (err) {
        console.warn("Could not fit bounds:", err);
      }

      setStatus("route loaded");
    } catch (err) {
      console.error(err);
      alert("Routing request failed. Check console for details.");
      setStatus("error");
    }
  }

  btnRoute.addEventListener("click", getSafeRoute);

  // Initial status
  updateInfoPanels();
  setStatus("idle");

  // ====== OPTIONAL: where you'd fetch real hazard data ======
  // For a real app, you could replace hazardFeatures with data from
  // USGS, NOAA, NASA, etc.
</script>

</body>
</html>
